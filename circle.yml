machine:
  services:
    - docker

dependencies:
  pre:
    - wget https://releases.hashicorp.com/terraform/0.10.5/terraform_0.10.5_linux_amd64.zip
    - unzip terraform_0.10.5_linux_amd64.zip
    - mv terraform /usr/local/bin
  override:
    - docker info
    - rm -rf app/node_modules
    - cd app && docker build --rm=false -t notejam .

test:
  override:
    - docker run notejam npm test
    - docker run -d -p 3000:3000 notejam
    - curl --retry 10 --retry-delay 5 -v http://localhost:3000

deployment:
  production:
    branch: master
    commands:
      - cd terraform/deploy && terraform init && terraform get && terraform taint aws_ecs_task_definition.webapp && terraform plan && terraform apply
